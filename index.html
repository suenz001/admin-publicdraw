<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…ç´šå¹¸é‹æŠ½æŠ½æ¨‚ - ç®¡ç†å¾Œå° v6</title>
    <style>
        :root {
            --sidebar-width: 250px;
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #ecf0f1;
        }
        body { margin: 0; font-family: "Segoe UI", sans-serif; background: var(--bg-color); display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: var(--sidebar-width); background: var(--primary-color); color: white; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .sidebar h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid #34495e; padding-bottom: 15px; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: var(--accent-color); }
        
        /* åˆ·æ–°æŒ‰éˆ•æ¨£å¼ */
        .btn-refresh { background: #27ae60 !important; font-weight: bold; text-align: center; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-refresh:active { transform: scale(0.98); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .admin-info { margin-top: auto; font-size: 0.8rem; color: #bdc3c7; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { margin: 0 0 10px 0; color: #7f8c8d; font-size: 0.9rem; }
        .card .number { font-size: 2.5rem; font-weight: bold; color: var(--primary-color); }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); table-layout: fixed; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; word-wrap: break-word; }
        th { background: #f8f9fa; font-weight: bold; color: #2c3e50; }
        tr:hover { background: #f1f2f6; }
        
        /* æ¬„ä½å¯¬åº¦è¨­å®š */
        th:nth-child(1) { width: 15%; } /* ID */
        th:nth-child(2) { width: 25%; } /* Email */
        th:nth-child(3) { width: 25%; } /* å°å­©è³‡è¨Š */
        th:nth-child(4) { width: 15%; } /* ä¸Šç·šæ™‚é–“ */
        th:nth-child(5) { width: 10%; } /* å®šå­˜ */
        th:nth-child(6) { width: 10%; } /* æ“ä½œ */

        .btn-del { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .tag { background: #dfe6e9; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; display: inline-block; margin-bottom: 2px;}

        .reward-cloud { display: flex; flex-wrap: wrap; gap: 10px; }
        .reward-tag { background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; border: 1px solid #eee; }
        .reward-tag strong { color: var(--accent-color); margin-left: 5px; }
        
        .default-tag { background: #f8f9fa; color: #7f8c8d; border: 1px dashed #ccc; }
        .default-tag strong { color: #95a5a6; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .login-box { background: white; padding: 30px; border-radius: 10px; color: #333; width: 300px; text-align: center; }
        .login-input { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        .btn-primary { background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1rem; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>ğŸ”’ ç®¡ç†å“¡ç™»å…¥</h2>
        <p>è«‹è¼¸å…¥æ‚¨çš„ Firebase å¸³è™Ÿå¯†ç¢¼</p>
        <input type="email" id="adminEmail" class="login-input" placeholder="Email">
        <input type="password" id="adminPass" class="login-input" placeholder="Password">
        <button class="btn-primary" onclick="adminLogin()">ç™»å…¥å¾Œå°</button>
        <p id="loginMsg" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<div class="sidebar">
    <h2>ğŸ› ï¸ Admin Panel</h2>
    <div class="menu-item active" onclick="switchPage('dashboard')">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</div>
    <div class="menu-item" onclick="switchPage('users')">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</div>
    <div class="menu-item" onclick="switchPage('rewards')">ğŸ çå“å¤§æ•¸æ“š</div>
    
    <div class="menu-item btn-refresh" onclick="reloadData()">ğŸ”„ ç«‹å³åˆ·æ–°</div>

    <div class="admin-info">
        ç›®å‰ç™»å…¥ï¼š<span id="currentAdmin">...</span><br>
        <a href="#" onclick="logout()" style="color:#e74c3c;">[ç™»å‡º]</a>
    </div>
</div>

<div class="main-content">
    
    <div id="dashboard" class="section active">
        <h1>ğŸ“Š ç³»çµ±ç¸½è¦½</h1>
        <div class="stats-grid">
            <div class="card">
                <h3>ç¸½ä½¿ç”¨äººæ•¸</h3>
                <div class="number" id="statTotalUsers">--</div>
            </div>
            <div class="card">
                <h3>æ´»èºç”¨æˆ¶ (7å¤©å…§)</h3>
                <div class="number" id="statActiveUsers">--</div>
            </div>
            <div class="card">
                <h3>ç¸½å®šå­˜é‡‘é¡</h3>
                <div class="number" id="statTotalDeposit" style="color:#27ae60">--</div>
            </div>
            <div class="card">
                <h3>å¹½éˆå¸³è™Ÿ (>30å¤©æœªç™»)</h3>
                <div class="number" id="statGhostUsers" style="color:#e74c3c">--</div>
            </div>
        </div>
        
        <h3>ğŸ“… æœ€æ–°è¨»å†Š/æ´»èº (Top 10)</h3>
        <table id="recentTable">
            <thead><tr><th>ID (å‰5ç¢¼)</th><th>Email</th><th>æœ€å¾Œä¸Šç·š</th><th>ç‹€æ…‹</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="users" class="section">
        <h1>ğŸ‘¥ ä½¿ç”¨è€…åˆ—è¡¨</h1>
        <div style="margin-bottom:15px;">
            <input type="text" id="searchInput" placeholder="æœå°‹ Email..." style="padding:8px; width:200px;" onkeyup="filterUsers()">
            <button onclick="deleteGhosts()" style="float:right; background:#c0392b; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">ğŸ§¹ æ¸…ç†å¹½éˆ (>180å¤©)</button>
        </div>
        <table id="userTable">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Email</th>
                    <th>å°å­©è³‡æ–™ (é»æ•¸)</th>
                    <th>æœ€å¾Œä¸Šç·š</th>
                    <th>å®šå­˜</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <div id="rewards" class="section">
        <h1>ğŸ å…¨çƒçˆ¸åª½çå‹µåƒè€ƒ</h1>
        <p>çµ±è¨ˆæ‰€æœ‰å®¶é•·è¨­å®šçš„çå“å…§å®¹ã€‚</p>
        
        <h3 style="color:#d35400;">ğŸ”¥ ç†±é–€ã€Œå®¢è£½åŒ–ã€çå“ (æ’é™¤é è¨­)</h3>
        <div id="popularRewards" class="reward-cloud"></div>

        <h3 style="margin-top:30px; color:#f1c40f;">ğŸŒŸ å‚³å¥‡/ç¥è©±ç´šã€Œå®¢è£½åŒ–ã€å¤§ç</h3>
        <div id="rareRewards" class="reward-cloud"></div>

        <h3 style="margin-top:40px; color:#7f8c8d; border-top:1px solid #ddd; padding-top:20px;">ğŸ“ é è¨­çå“ä½¿ç”¨ç‡çµ±è¨ˆ</h3>
        <div id="defaultRewards" class="reward-cloud"></div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCArCzhRG6H-07Ooet34ikyP3w9xVq6t1U",
      authDomain: "kidrewardapp.firebaseapp.com",
      projectId: "kidrewardapp",
      storageBucket: "kidrewardapp.firebasestorage.app",
      messagingSenderId: "980449979485",
      appId: "1:980449979485:web:652d6b419385e76ad071b4",
      measurementId: "G-L86Y9Y477Y"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let allUsersData = [];

    // === é è¨­çå“æ¸…å–® ===
    const DEFAULT_REWARDS_LIST = [
        'å°æ—¥è¨˜æ¸›å°‘ä¸€è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 5åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•5åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“5åˆ†é˜',
        'å°æ—¥è¨˜æ¸›å°‘äºŒè¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•10åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“10åˆ†é˜',
        'å°æ—¥è¨˜æ¸›å°‘ä¸‰è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 15åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•15åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“15åˆ†é˜', 'åª½åª½é™ªç¡è¦º',
        'å°æ—¥è¨˜æ¸›å°‘å››è¡Œ', 'å¹³æ—¥å¯ç©é›»å‹•10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•15åˆ†é˜', 'å¢åŠ é»æ•¸200é»',
        'å¹³æ—¥å¯ç©é›»å‹•15åˆ†é˜', 'é›¶ç”¨éŒ¢100å…ƒ', 'å¢åŠ é»æ•¸300é»',
        'å¹³æ—¥å¯ç©é›»å‹•30åˆ†é˜', 'å¯ä»»æ„é¸è³¼500å…ƒå…§çš„å°ç¦®ç‰©', 'æ‰“æ‰‹å¿ƒè™•ç½°æ¸›å…ä¸€æ¬¡', 'å¢åŠ é»æ•¸500é»'
    ];
    const defaultRewardSet = new Set(DEFAULT_REWARDS_LIST);

    // === ç®¡ç†å“¡ç™»å…¥æª¢æŸ¥ (å« Email é–å®š) ===
    window.adminLogin = async function() {
        const e = document.getElementById('adminEmail').value;
        const p = document.getElementById('adminPass').value;
        const msg = document.getElementById('loginMsg');
        
        // ğŸ” æŒ‡å®šçš„å”¯ä¸€ç®¡ç†å“¡å¸³è™Ÿ
        const ALLOWED_ADMIN_EMAIL = "suenz001@yahoo.com.tw";

        if(!e || !p) { msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        
        try {
            msg.innerText = "é©—è­‰èº«åˆ†ä¸­...";
            const userCred = await signInWithEmailAndPassword(auth, e, p);
            
            // ğŸš« æª¢æŸ¥ Email æ˜¯å¦ç¬¦åˆ
            if(userCred.user.email !== ALLOWED_ADMIN_EMAIL) {
                await signOut(auth); // å¼·åˆ¶ç™»å‡º
                msg.innerText = "â›” æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯æŒ‡å®šçš„ç®¡ç†å“¡ï¼";
                return;
            }

            document.getElementById('currentAdmin').innerText = userCred.user.email;
            msg.innerText = "è®€å–è³‡æ–™åº«ä¸­...";
            await fetchAllData();
            document.getElementById('loginOverlay').style.display = 'none';
        } catch (error) { msg.innerText = "ç™»å…¥å¤±æ•—ï¼š" + error.message; }
    }

    window.logout = function() { signOut(auth).then(() => location.reload()); }

    // === ğŸ”„ æ–°å¢ï¼šåˆ·æ–°è³‡æ–™åŠŸèƒ½ ===
    window.reloadData = async function() {
        if(!document.getElementById('currentAdmin').innerText || document.getElementById('currentAdmin').innerText === '...') {
            alert("è«‹å…ˆç™»å…¥");
            return;
        }
        document.body.style.cursor = 'wait'; // è®Šæ›´æ¸¸æ¨™ç‚ºç­‰å¾…
        await fetchAllData();
        document.body.style.cursor = 'default';
        alert("è³‡æ–™å·²æ›´æ–°ï¼");
    }

    async function fetchAllData() {
        try {
            const querySnapshot = await getDocs(collection(db, "users"));
            allUsersData = [];
            querySnapshot.forEach((doc) => {
                let d = doc.data();
                d.uid = doc.id;
                if(!d.children && d.score !== undefined) { d.children = [{name: "(èˆŠç‰ˆ)", data: d}]; }
                if(!d.children) d.children = [];
                allUsersData.push(d);
            });
            console.log("Data loaded:", allUsersData.length);
            renderDashboard();
            renderUserTable();
            analyzeRewards();
        } catch (e) { alert("è®€å–è³‡æ–™åº«å¤±æ•—: " + e.message); }
    }

    function renderDashboard() {
        const now = new Date();
        let activeCount = 0, ghostCount = 0, totalDeposit = 0;
        allUsersData.forEach(u => {
            let lastLogin = new Date(u.lastLoginDate);
            if(!u.lastLoginDate || isNaN(lastLogin.getTime())) lastLogin = new Date(0);
            const diffDays = (now - lastLogin) / (1000 * 60 * 60 * 24);
            if(diffDays <= 7) activeCount++;
            if(diffDays > 30) ghostCount++;
            if(u.children) {
                u.children.forEach(c => {
                    if(c.data && c.data.deposits) c.data.deposits.forEach(dep => totalDeposit += parseInt(dep.amount || 0));
                });
            }
        });

        document.getElementById('statTotalUsers').innerText = allUsersData.length;
        document.getElementById('statActiveUsers').innerText = activeCount;
        document.getElementById('statTotalDeposit').innerText = totalDeposit.toLocaleString();
        document.getElementById('statGhostUsers').innerText = ghostCount;

        const recentList = [...allUsersData].sort((a,b) => {
            let dateA = new Date(a.lastLoginDate || 0);
            let dateB = new Date(b.lastLoginDate || 0);
            return dateB - dateA;
        }).slice(0, 10);

        document.querySelector('#recentTable tbody').innerHTML = recentList.map(u => {
            let timeStr = u.lastLoginDate ? new Date(u.lastLoginDate).toLocaleString() : "æœªçŸ¥";
            return `
            <tr>
                <td>${u.uid.substring(0,5)}...</td>
                <td>${u.email || '<span style="color:#aaa">(å°šæœªè¨˜éŒ„)</span>'}</td>
                <td>${timeStr}</td>
                <td>${u.children.length} å­</td>
            </tr>`;
        }).join('');
    }

    function renderUserTable() {
        const tbody = document.getElementById('userTableBody');
        let html = '';
        allUsersData.forEach(u => {
            let childrenInfo = "";
            let depositCount = 0;
            if(u.children) {
                u.children.forEach(c => {
                    childrenInfo += `<span class="tag">${c.name}: ${c.data.score}é»</span>`;
                    if(c.data.deposits) depositCount += c.data.deposits.length;
                });
            }
            
            let lastLogin = new Date(u.lastLoginDate || 0);
            let timeStr = u.lastLoginDate ? lastLogin.toLocaleString() : "æœªçŸ¥";
            const isGhost = (new Date() - lastLogin) > (30 * 86400000);
            
            html += `
            <tr>
                <td><small style="color:#aaa; font-family:monospace;">${u.uid}</small></td>
                <td><strong>${u.email ? u.email : '<span style="color:#f39c12">æœªå›å¯«</span>'}</strong></td>
                <td>${childrenInfo}</td>
                <td style="color:${isGhost?'red':'green'}">${timeStr}</td>
                <td>${depositCount}</td>
                <td><button class="btn-del" onclick="deleteUser('${u.uid}')">åˆªé™¤</button></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function analyzeRewards() {
        let customCounts = {};
        let defaultCounts = {};
        let highTierCustom = [];

        allUsersData.forEach(u => {
            let tiers = u.tiers || (u.children && u.children[0] ? u.children[0].data.tiers : null);
            if(tiers) {
                tiers.forEach((t, index) => {
                    if(!t.rewards) return;
                    t.rewards.forEach(r => {
                        if (defaultRewardSet.has(r)) {
                            defaultCounts[r] = (defaultCounts[r] || 0) + 1;
                        } else {
                            customCounts[r] = (customCounts[r] || 0) + 1;
                            if(index >= 4) highTierCustom.push(r);
                        }
                    });
                });
            }
        });

        const sortedCustom = Object.entries(customCounts).sort((a,b) => b[1] - a[1]).slice(0, 50);
        document.getElementById('popularRewards').innerHTML = sortedCustom.length > 0 ? sortedCustom.map(item => 
            `<span class="reward-tag">${item[0]} <strong>x${item[1]}</strong></span>`
        ).join('') : '<span style="color:#aaa; padding:10px;">å°šæœªæœ‰å®¢è£½åŒ–çå“æ•¸æ“š</span>';

        const uniqueHigh = [...new Set(highTierCustom)];
        document.getElementById('rareRewards').innerHTML = uniqueHigh.length > 0 ? uniqueHigh.map(name => 
            `<span class="reward-tag" style="border:2px solid #f1c40f; background:#fffcf5; color:#d35400;">${name}</span>`
        ).join('') : '<span style="color:#aaa; padding:10px;">å°šæœªæœ‰é«˜ç´šå®¢è£½åŒ–çå“</span>';

        const sortedDefault = Object.entries(defaultCounts).sort((a,b) => b[1] - a[1]);
        document.getElementById('defaultRewards').innerHTML = sortedDefault.map(item => 
            `<span class="reward-tag default-tag">${item[0]} <strong>x${item[1]}</strong></span>`
        ).join('');
    }

    window.deleteUser = async function(uid) {
        if(confirm('âš ï¸ åªèƒ½åˆªé™¤è³‡æ–™åº«ç´€éŒ„ï¼Œç„¡æ³•åˆªé™¤å¸³è™Ÿã€‚\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
            try {
                await deleteDoc(doc(db, "users", uid));
                alert("å·²åˆªé™¤");
                allUsersData = allUsersData.filter(u => u.uid !== uid);
                renderUserTable(); renderDashboard();
            } catch(e) { alert("å¤±æ•—: " + e.message); }
        }
    }

    window.deleteGhosts = async function() {
        if(!confirm('âš ï¸ åˆªé™¤æ‰€æœ‰ >180 å¤©æœªç™»å…¥çš„è³‡æ–™ç´€éŒ„ï¼Ÿ')) return;
        const now = new Date(); let count = 0;
        for (let u of allUsersData) {
            let last = new Date(u.lastLoginDate || 0);
            if((now - last) / 86400000 > 180) {
                try { await deleteDoc(doc(db, "users", u.uid)); count++; } catch(e) {}
            }
        }
        alert(`æ¸…ç† ${count} ç­†è³‡æ–™`); location.reload();
    }

    window.filterUsers = function() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('#userTableBody tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
        });
    }

    window.switchPage = function(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }
</script>
</body>
</html>