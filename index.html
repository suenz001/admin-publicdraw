<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶…ç´šå¹¸é‹æŠ½æŠ½æ¨‚ - ç®¡ç†å¾Œå° v9 (æ‰‹æ©Ÿç‰ˆå„ªåŒ–)</title>
    <style>
        :root {
            --sidebar-width: 250px;
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #ecf0f1;
            --header-height: 60px;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg-color); display: flex; height: 100vh; overflow: hidden; }
        
        /* === å´é‚Šæ¬„ (é›»è…¦ç‰ˆ) === */
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--primary-color); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            box-sizing: border-box; 
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #34495e; padding-bottom: 15px; margin-bottom: 15px; }
        .sidebar h2 { margin: 0; font-size: 1.2rem; }
        .mobile-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        .menu-item { padding: 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: block; }
        .menu-item:hover, .menu-item.active { background: var(--accent-color); }
        
        .btn-refresh { background: #27ae60 !important; font-weight: bold; text-align: center; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-refresh:active { transform: scale(0.98); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .admin-info { margin-top: auto; font-size: 0.8rem; color: #bdc3c7; padding-top: 20px; }

        /* === ä¸»å…§å®¹å€ === */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* === çµ±è¨ˆå¡ç‰‡ === */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { margin: 0 0 10px 0; color: #7f8c8d; font-size: 0.9rem; }
        .card .number { font-size: 2.5rem; font-weight: bold; color: var(--primary-color); }

        /* === è¡¨æ ¼å„ªåŒ– (RWD) === */
        .table-responsive { width: 100%; overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; /* å¼·åˆ¶æœ€å°å¯¬åº¦ï¼Œè§¸ç™¼æ²å‹• */ }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background: #f8f9fa; font-weight: bold; color: #2c3e50; position: sticky; top: 0; }
        tr:hover { background: #f1f2f6; }

        .btn-del { background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .tag { background: #dfe6e9; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; display: inline-block; margin-bottom: 2px;}

        /* === çå“é›² === */
        .reward-cloud { display: flex; flex-wrap: wrap; gap: 10px; }
        .reward-tag { background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; border: 1px solid #eee; }
        .reward-tag strong { color: var(--accent-color); margin-left: 5px; }
        .default-tag { background: #f8f9fa; color: #7f8c8d; border: 1px dashed #ccc; }

        /* === ä¿¡ç®±æ¨£å¼ === */
        .mail-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; }
        .mail-item.unread { border-left-color: #e74c3c; background: #fff5f5; }
        .mail-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; color: #7f8c8d; flex-wrap: wrap; gap: 5px; }
        .mail-content { font-size: 1rem; color: #2c3e50; line-height: 1.5; white-space: pre-wrap; margin-bottom: 10px; }
        .mail-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-read { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .btn-read.is-read { background: #95a5a6; }

        /* === ç™»å…¥é®ç½© === */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .login-box { background: white; padding: 30px; border-radius: 10px; color: #333; width: 90%; max-width: 320px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        .btn-primary { background: var(--accent-color); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; }

        /* === æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­å®š (RWD) === */
        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; }
            
            /* å´é‚Šæ¬„è®Šç‚ºé ‚éƒ¨å°è¦½åˆ— */
            .sidebar { 
                width: 100%; 
                height: auto; 
                flex-direction: row; 
                align-items: center; 
                flex-wrap: wrap; 
                padding: 10px 15px; 
                position: relative; 
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                flex-shrink: 0;
            }
            
            .sidebar-header { width: 100%; margin: 0; border: none; padding: 0; }
            .mobile-toggle { display: block; }
            
            /* é¸å–®é …ç›®é è¨­éš±è—ï¼Œé»æ“Šæ¼¢å ¡å¾Œé¡¯ç¤º */
            .menu-group { display: none; width: 100%; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px; padding-top: 10px; }
            .sidebar.open .menu-group { display: block; }
            
            .menu-item { text-align: center; padding: 12px; margin-bottom: 5px; font-size: 1.1rem; }
            .admin-info { text-align: center; padding: 15px 0 5px 0; border-top: 1px dashed rgba(255,255,255,0.2); margin-top: 15px; }

            /* ä¸»å…§å®¹å€èª¿æ•´ */
            .main-content { padding: 15px; width: 100%; }
            h1 { font-size: 1.5rem; margin-top: 0; }
            
            /* å¡ç‰‡èˆ‡å­—é«”èª¿æ•´ */
            .card .number { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            
            /* æŒ‰éˆ•åŠ å¤§å¥½é»æ“Š */
            button { min-height: 40px; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>ğŸ”’ ç®¡ç†å“¡ç™»å…¥</h2>
        <p>è«‹è¼¸å…¥æ‚¨çš„ Firebase å¸³è™Ÿå¯†ç¢¼</p>
        <input type="email" id="adminEmail" class="login-input" placeholder="Email">
        <input type="password" id="adminPass" class="login-input" placeholder="Password">
        <button class="btn-primary" onclick="adminLogin()">ç™»å…¥å¾Œå°</button>
        <p id="loginMsg" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2>ğŸ› ï¸ Admin Panel</h2>
        <button class="mobile-toggle" onclick="toggleMobileMenu()">â˜°</button>
    </div>
    
    <div class="menu-group">
        <div class="menu-item active" onclick="switchPage('dashboard')">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</div>
        <div class="menu-item" onclick="switchPage('users')">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</div>
        <div class="menu-item" onclick="switchPage('rewards')">ğŸ çå“å¤§æ•¸æ“š</div>
        <div class="menu-item" onclick="switchPage('mailbox')">ğŸ“¬ ä¿¡ç®±ç®¡ç† <span id="unreadBadge" style="background:#e74c3c; padding:2px 8px; border-radius:10px; font-size:0.8rem; display:none;">0</span></div>
        
        <div class="menu-item btn-refresh" onclick="reloadData()">ğŸ”„ ç«‹å³åˆ·æ–°</div>

        <div class="admin-info">
            ç™»å…¥è€…ï¼š<span id="currentAdmin">...</span><br>
            <a href="#" onclick="logout()" style="color:#e74c3c; font-weight:bold; display:inline-block; margin-top:5px; text-decoration:none;">[ç™»å‡º]</a>
        </div>
    </div>
</div>

<div class="main-content">
    
    <div id="dashboard" class="section active">
        <h1>ğŸ“Š ç³»çµ±ç¸½è¦½</h1>
        <div class="stats-grid">
            <div class="card">
                <h3>ç¸½ä½¿ç”¨äººæ•¸</h3>
                <div class="number" id="statTotalUsers">--</div>
            </div>
            <div class="card">
                <h3>æ´»èºç”¨æˆ¶ (7å¤©)</h3>
                <div class="number" id="statActiveUsers">--</div>
            </div>
            <div class="card">
                <h3>ç¸½å®šå­˜é‡‘é¡</h3>
                <div class="number" id="statTotalDeposit" style="color:#27ae60">--</div>
            </div>
            <div class="card">
                <h3>å¹½éˆ (>30å¤©)</h3>
                <div class="number" id="statGhostUsers" style="color:#e74c3c">--</div>
            </div>
        </div>
        
        <h3>ğŸ“… æœ€æ–°è¨»å†Š/æ´»èº (Top 10)</h3>
        <div class="table-responsive">
            <table id="recentTable">
                <thead><tr><th>ID (å‰5ç¢¼)</th><th>Email</th><th>æœ€å¾Œä¸Šç·š</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="users" class="section">
        <h1>ğŸ‘¥ ä½¿ç”¨è€…åˆ—è¡¨</h1>
        <div style="margin-bottom:15px; display:flex; gap:10px;">
            <input type="text" id="searchInput" placeholder="æœå°‹ Email..." style="padding:10px; flex:1; border:1px solid #ccc; border-radius:5px;" onkeyup="filterUsers()">
            <button onclick="deleteGhosts()" style="background:#c0392b; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; white-space:nowrap;">ğŸ§¹ æ¸…ç†</button>
        </div>
        <div class="table-responsive">
            <table id="userTable">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Email</th>
                        <th>å°å­©è³‡æ–™ (é»æ•¸)</th>
                        <th>æœ€å¾Œä¸Šç·š</th>
                        <th>å®šå­˜</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="rewards" class="section">
        <h1>ğŸ å…¨çƒçˆ¸åª½çå‹µåƒè€ƒ</h1>
        <p>çµ±è¨ˆæ‰€æœ‰å®¶é•·è¨­å®šçš„çå“å…§å®¹ã€‚</p>
        
        <h3 style="color:#d35400;">ğŸ”¥ ç†±é–€ã€Œå®¢è£½åŒ–ã€çå“ (æ’é™¤é è¨­)</h3>
        <div id="popularRewards" class="reward-cloud"></div>

        <h3 style="margin-top:30px; color:#f1c40f;">ğŸŒŸ å‚³å¥‡/ç¥è©±ç´šã€Œå®¢è£½åŒ–ã€å¤§ç</h3>
        <div id="rareRewards" class="reward-cloud"></div>

        <h3 style="margin-top:40px; color:#7f8c8d; border-top:1px solid #ddd; padding-top:20px;">ğŸ“ é è¨­çå“ä½¿ç”¨ç‡çµ±è¨ˆ</h3>
        <div id="defaultRewards" class="reward-cloud"></div>
    </div>

    <div id="mailbox" class="section">
        <h1>ğŸ“¬ ä¿¡ç®±ç®¡ç†</h1>
        <p>ä¾†è‡ªä½¿ç”¨è€…çš„æ„è¦‹å›é¥‹ã€‚</p>
        <div id="mailList">è¼‰å…¥ä¸­...</div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCArCzhRG6H-07Ooet34ikyP3w9xVq6t1U",
      authDomain: "kidrewardapp.firebaseapp.com",
      projectId: "kidrewardapp",
      storageBucket: "kidrewardapp.firebasestorage.app",
      messagingSenderId: "980449979485",
      appId: "1:980449979485:web:652d6b419385e76ad071b4",
      measurementId: "G-L86Y9Y477Y"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let allUsersData = [];

    const DEFAULT_REWARDS_LIST = [
        'å°æ—¥è¨˜æ¸›å°‘ä¸€è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 5åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•5åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“5åˆ†é˜',
        'å°æ—¥è¨˜æ¸›å°‘äºŒè¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•10åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“10åˆ†é˜',
        'å°æ—¥è¨˜æ¸›å°‘ä¸‰è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 15åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•15åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“15åˆ†é˜', 'åª½åª½é™ªç¡è¦º',
        'å°æ—¥è¨˜æ¸›å°‘å››è¡Œ', 'å¹³æ—¥å¯ç©é›»å‹•10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•30åˆ†é˜', 'å¢åŠ é»æ•¸200é»',
        'å¹³æ—¥å¯ç©é›»å‹•15åˆ†é˜', 'é›¶ç”¨éŒ¢100å…ƒ', 'å¢åŠ é»æ•¸300é»',
        'å¹³æ—¥å¯ç©é›»å‹•30åˆ†é˜', 'å¯ä»»æ„é¸è³¼500å…ƒå…§çš„å°ç¦®ç‰©', 'æ‰“æ‰‹å¿ƒè™•ç½°æ¸›å…ä¸€æ¬¡', 'å¢åŠ é»æ•¸500é»'
    ];
    const defaultRewardSet = new Set(DEFAULT_REWARDS_LIST);

    // æ‰‹æ©Ÿç‰ˆé¸å–®åˆ‡æ›
    window.toggleMobileMenu = function() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    // åˆ‡æ›é é¢å¾Œè‡ªå‹•é—œé–‰æ‰‹æ©Ÿé¸å–®
    window.switchPage = function(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        
        // æ‰¾åˆ°ä¸¦é«˜äº®ç•¶å‰æŒ‰éˆ•
        const clickedBtn = [...document.querySelectorAll('.menu-item')].find(el => el.getAttribute('onclick') && el.getAttribute('onclick').includes(id));
        if(clickedBtn) clickedBtn.classList.add('active');
        
        // é‡æ–°æŠ“å–ä¿¡ç®±
        if (id === 'mailbox') fetchMessages();
        
        // é—œé–‰æ‰‹æ©Ÿé¸å–®
        document.getElementById('sidebar').classList.remove('open');
    }

    window.adminLogin = async function() {
        const e = document.getElementById('adminEmail').value;
        const p = document.getElementById('adminPass').value;
        const msg = document.getElementById('loginMsg');
        
        const ALLOWED_ADMIN_EMAIL = "suenz001@yahoo.com.tw";

        if(!e || !p) { msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        
        try {
            msg.innerText = "é©—è­‰èº«åˆ†ä¸­...";
            const userCred = await signInWithEmailAndPassword(auth, e, p);
            
            if(userCred.user.email !== ALLOWED_ADMIN_EMAIL) {
                await signOut(auth);
                msg.innerText = "â›” æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯æŒ‡å®šçš„ç®¡ç†å“¡ï¼";
                return;
            }

            document.getElementById('currentAdmin').innerText = userCred.user.email;
            msg.innerText = "è®€å–è³‡æ–™åº«ä¸­...";
            await fetchAllData();
            await fetchMessages();
            document.getElementById('loginOverlay').style.display = 'none';
        } catch (error) { msg.innerText = "ç™»å…¥å¤±æ•—ï¼š" + error.message; }
    }

    window.logout = function() { signOut(auth).then(() => location.reload()); }

    window.reloadData = async function() {
        if(!document.getElementById('currentAdmin').innerText || document.getElementById('currentAdmin').innerText === '...') {
            alert("è«‹å…ˆç™»å…¥");
            return;
        }
        document.body.style.cursor = 'wait';
        await fetchAllData();
        await fetchMessages();
        document.body.style.cursor = 'default';
        alert("è³‡æ–™å·²æ›´æ–°ï¼");
        document.getElementById('sidebar').classList.remove('open');
    }

    async function fetchAllData() {
        try {
            const querySnapshot = await getDocs(collection(db, "users"));
            allUsersData = [];
            querySnapshot.forEach((doc) => {
                let d = doc.data();
                d.uid = doc.id;
                if(!d.children && d.score !== undefined) { d.children = [{name: "(èˆŠç‰ˆ)", data: d}]; }
                if(!d.children) d.children = [];
                allUsersData.push(d);
            });
            
            allUsersData.sort((a, b) => {
                const isGuestA = !a.email || a.email.startsWith('ğŸ‘»');
                const isGuestB = !b.email || b.email.startsWith('ğŸ‘»');
                if (isGuestA !== isGuestB) return isGuestA - isGuestB;
                let dateA = new Date(a.lastLoginDate || 0);
                let dateB = new Date(b.lastLoginDate || 0);
                return dateB - dateA; 
            });

            renderDashboard();
            renderUserTable();
            analyzeRewards();
        } catch (e) { alert("è®€å–è³‡æ–™åº«å¤±æ•—: " + e.message); }
    }

    async function fetchMessages() {
        try {
            const q = query(collection(db, "messages"));
            const snapshot = await getDocs(q);
            let msgs = [];
            snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));

            msgs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const mailList = document.getElementById('mailList');
            if (msgs.length === 0) {
                mailList.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">ç›®å‰æ²’æœ‰ä»»ä½•ä¿¡ä»¶</div>';
                updateUnreadBadge(0);
                return;
            }

            let unreadCount = 0;
            let html = msgs.map(m => {
                if (!m.read) unreadCount++;
                const timeStr = new Date(m.timestamp).toLocaleString();
                const btnText = m.read ? 'å·²è®€' : 'æ¨™ç¤ºå·²è®€';
                const btnClass = m.read ? 'btn-read is-read' : 'btn-read';
                
                return `
                <div class="mail-item ${m.read ? '' : 'unread'}">
                    <div class="mail-header">
                        <span>From: <strong>${m.sender || 'Unknown'}</strong></span>
                        <span style="font-size:0.8rem;">${timeStr}</span>
                    </div>
                    <div class="mail-content">${m.content}</div>
                    <div class="mail-actions">
                        <button class="${btnClass}" onclick="toggleRead('${m.id}', ${m.read})">${btnText}</button>
                        <button class="btn-del" onclick="deleteMessage('${m.id}')">åˆªé™¤</button>
                    </div>
                </div>`;
            }).join('');
            
            mailList.innerHTML = html;
            updateUnreadBadge(unreadCount);

        } catch (e) {
            console.error(e);
            document.getElementById('mailList').innerText = "è®€å–ä¿¡ç®±å¤±æ•—: " + e.message;
        }
    }

    function updateUnreadBadge(count) {
        const badge = document.getElementById('unreadBadge');
        if (count > 0) {
            badge.style.display = 'inline-block';
            badge.innerText = count;
        } else {
            badge.style.display = 'none';
        }
    }

    window.toggleRead = async function(id, currentStatus) {
        try {
            const ref = doc(db, "messages", id);
            await updateDoc(ref, { read: !currentStatus });
            await fetchMessages(); 
        } catch (e) { alert("æ›´æ–°å¤±æ•—: " + e.message); }
    }

    window.deleteMessage = async function(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å°ä¿¡å—ï¼Ÿ")) return;
        try {
            await deleteDoc(doc(db, "messages", id));
            await fetchMessages();
        } catch (e) { alert("åˆªé™¤å¤±æ•—: " + e.message); }
    }

    function renderDashboard() {
        const now = new Date();
        let activeCount = 0, ghostCount = 0, totalDeposit = 0;
        allUsersData.forEach(u => {
            let lastLogin = new Date(u.lastLoginDate);
            if(!u.lastLoginDate || isNaN(lastLogin.getTime())) lastLogin = new Date(0);
            const diffDays = (now - lastLogin) / (1000 * 60 * 60 * 24);
            if(diffDays <= 7) activeCount++;
            if(diffDays > 30) ghostCount++;
            if(u.children) {
                u.children.forEach(c => {
                    if(c.data && c.data.deposits) c.data.deposits.forEach(dep => totalDeposit += parseInt(dep.amount || 0));
                });
            }
        });

        document.getElementById('statTotalUsers').innerText = allUsersData.length;
        document.getElementById('statActiveUsers').innerText = activeCount;
        document.getElementById('statTotalDeposit').innerText = totalDeposit.toLocaleString();
        document.getElementById('statGhostUsers').innerText = ghostCount;

        const recentList = [...allUsersData].sort((a,b) => {
            let dateA = new Date(a.lastLoginDate || 0);
            let dateB = new Date(b.lastLoginDate || 0);
            return dateB - dateA;
        }).slice(0, 10);

        document.querySelector('#recentTable tbody').innerHTML = recentList.map(u => {
            let timeStr = u.lastLoginDate ? new Date(u.lastLoginDate).toLocaleString() : "æœªçŸ¥";
            return `
            <tr>
                <td>${u.uid.substring(0,5)}...</td>
                <td>${u.email || '<span style="color:#aaa">(å°šæœªè¨˜éŒ„)</span>'}</td>
                <td>${timeStr}</td>
                <td>${u.children.length} å­</td>
            </tr>`;
        }).join('');
    }

    function renderUserTable() {
        const tbody = document.getElementById('userTableBody');
        let html = '';
        allUsersData.forEach(u => {
            let childrenInfo = "";
            let depositCount = 0;
            if(u.children) {
                u.children.forEach(c => {
                    childrenInfo += `<span class="tag">${c.name}: ${c.data.score}é»</span>`;
                    if(c.data.deposits) depositCount += c.data.deposits.length;
                });
            }
            
            let lastLogin = new Date(u.lastLoginDate || 0);
            let timeStr = u.lastLoginDate ? lastLogin.toLocaleString() : "æœªçŸ¥";
            const isGhost = (new Date() - lastLogin) > (30 * 86400000);
            
            html += `
            <tr>
                <td><small style="color:#aaa; font-family:monospace;">${u.uid}</small></td>
                <td><strong>${u.email ? u.email : '<span style="color:#f39c12">æœªå›å¯«</span>'}</strong></td>
                <td>${childrenInfo}</td>
                <td style="color:${isGhost?'red':'green'}">${timeStr}</td>
                <td>${depositCount}</td>
                <td><button class="btn-del" onclick="deleteUser('${u.uid}')">åˆªé™¤</button></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function analyzeRewards() {
        let customCounts = {};
        let defaultCounts = {};
        let highTierCustom = [];

        allUsersData.forEach(u => {
            let tiers = u.tiers || (u.children && u.children[0] ? u.children[0].data.tiers : null);
            if(tiers) {
                tiers.forEach((t, index) => {
                    if(!t.rewards) return;
                    t.rewards.forEach(r => {
                        if (defaultRewardSet.has(r)) {
                            defaultCounts[r] = (defaultCounts[r] || 0) + 1;
                        } else {
                            customCounts[r] = (customCounts[r] || 0) + 1;
                            if(index >= 4) highTierCustom.push(r);
                        }
                    });
                });
            }
        });

        const sortedCustom = Object.entries(customCounts).sort((a,b) => b[1] - a[1]).slice(0, 50);
        document.getElementById('popularRewards').innerHTML = sortedCustom.length > 0 ? sortedCustom.map(item => 
            `<span class="reward-tag">${item[0]} <strong>x${item[1]}</strong></span>`
        ).join('') : '<span style="color:#aaa; padding:10px;">å°šæœªæœ‰å®¢è£½åŒ–çå“æ•¸æ“š</span>';

        const uniqueHigh = [...new Set(highTierCustom)];
        document.getElementById('rareRewards').innerHTML = uniqueHigh.length > 0 ? uniqueHigh.map(name => 
            `<span class="reward-tag" style="border:2px solid #f1c40f; background:#fffcf5; color:#d35400;">${name}</span>`
        ).join('') : '<span style="color:#aaa; padding:10px;">å°šæœªæœ‰é«˜ç´šå®¢è£½åŒ–çå“</span>';

        const sortedDefault = Object.entries(defaultCounts).sort((a,b) => b[1] - a[1]);
        document.getElementById('defaultRewards').innerHTML = sortedDefault.map(item => 
            `<span class="reward-tag default-tag">${item[0]} <strong>x${item[1]}</strong></span>`
        ).join('');
    }

    window.deleteUser = async function(uid) {
        if(confirm('âš ï¸ åªèƒ½åˆªé™¤è³‡æ–™åº«ç´€éŒ„ï¼Œç„¡æ³•åˆªé™¤å¸³è™Ÿã€‚\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
            try {
                await deleteDoc(doc(db, "users", uid));
                alert("å·²åˆªé™¤");
                allUsersData = allUsersData.filter(u => u.uid !== uid);
                renderUserTable(); renderDashboard();
            } catch(e) { alert("å¤±æ•—: " + e.message); }
        }
    }

    window.deleteGhosts = async function() {
        if(!confirm('âš ï¸ åˆªé™¤æ‰€æœ‰ >180 å¤©æœªç™»å…¥çš„è³‡æ–™ç´€éŒ„ï¼Ÿ')) return;
        const now = new Date(); let count = 0;
        for (let u of allUsersData) {
            let last = new Date(u.lastLoginDate || 0);
            if((now - last) / 86400000 > 180) {
                try { await deleteDoc(doc(db, "users", u.uid)); count++; } catch(e) {}
            }
        }
        alert(`æ¸…ç† ${count} ç­†è³‡æ–™`); location.reload();
    }

    window.filterUsers = function() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('#userTableBody tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
        });
    }
</script>
</body>
</html>